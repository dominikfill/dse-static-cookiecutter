/*!
 * acdh-noske-search
 * by Daniel Elsner, https://github.com/acdh-oeaw/acdh-noske-search
 * Copyright (c) 2024 Austrian Centre for Digital Humanities & Cultural Heritage
 * code repo 
 * Licensed under MIT (https://github.com/acdh-oeaw/acdh-noske-search/blob/main/LICENSE)
 */

var le=Object.defineProperty;var ue=(r,e,t)=>e in r?le(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var c=(r,e,t)=>ue(r,typeof e!="symbol"?e+"":e,t);var M=class{constructor(){c(this,"_fns");this._fns=[]}eject(e){let t=this._fns.indexOf(e);t!==-1&&(this._fns=[...this._fns.slice(0,t),...this._fns.slice(t+1)])}use(e){this._fns=[...this._fns,e]}},m={BASE:"",CREDENTIALS:"include",ENCODE_PATH:void 0,HEADERS:void 0,PASSWORD:void 0,TOKEN:void 0,USERNAME:void 0,VERSION:"2.0.0",WITH_CREDENTIALS:!1,interceptors:{request:new M,response:new M}};var k=class extends Error{constructor(t,s,i){super(i);c(this,"url");c(this,"status");c(this,"statusText");c(this,"body");c(this,"request");this.name="ApiError",this.url=s.url,this.status=s.status,this.statusText=s.statusText,this.body=s.body,this.request=t}};var B=class extends Error{constructor(e){super(e),this.name="CancelError"}get isCancelled(){return!0}},$=class{constructor(e){c(this,"_isResolved");c(this,"_isRejected");c(this,"_isCancelled");c(this,"cancelHandlers");c(this,"promise");c(this,"_resolve");c(this,"_reject");this._isResolved=!1,this._isRejected=!1,this._isCancelled=!1,this.cancelHandlers=[],this.promise=new Promise((t,s)=>{this._resolve=t,this._reject=s;let i=a=>{this._isResolved||this._isRejected||this._isCancelled||(this._isResolved=!0,this._resolve&&this._resolve(a))},o=a=>{this._isResolved||this._isRejected||this._isCancelled||(this._isRejected=!0,this._reject&&this._reject(a))},n=a=>{this._isResolved||this._isRejected||this._isCancelled||this.cancelHandlers.push(a)};return Object.defineProperty(n,"isResolved",{get:()=>this._isResolved}),Object.defineProperty(n,"isRejected",{get:()=>this._isRejected}),Object.defineProperty(n,"isCancelled",{get:()=>this._isCancelled}),e(i,o,n)})}get[Symbol.toStringTag](){return"Cancellable Promise"}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}cancel(){if(!(this._isResolved||this._isRejected||this._isCancelled)){if(this._isCancelled=!0,this.cancelHandlers.length)try{for(let e of this.cancelHandlers)e()}catch(e){console.warn("Cancellation threw an error",e);return}this.cancelHandlers.length=0,this._reject&&this._reject(new B("Request aborted"))}}get isCancelled(){return this._isCancelled}};var F=r=>typeof r=="string",V=r=>F(r)&&r!=="",J=r=>r instanceof Blob,K=r=>r instanceof FormData,de=r=>r>=200&&r<300,me=r=>{try{return btoa(r)}catch{return Buffer.from(r).toString("base64")}},ye=r=>{let e=[],t=(i,o)=>{e.push(`${encodeURIComponent(i)}=${encodeURIComponent(String(o))}`)},s=(i,o)=>{o!=null&&(o instanceof Date?t(i,o.toISOString()):Array.isArray(o)?o.forEach(n=>s(i,n)):typeof o=="object"?Object.entries(o).forEach(([n,a])=>s(`${i}[${n}]`,a)):t(i,o))};return Object.entries(r).forEach(([i,o])=>s(i,o)),e.length?`?${e.join("&")}`:""},ge=(r,e)=>{let t=r.ENCODE_PATH||encodeURI,s=e.url.replace("{api-version}",r.VERSION).replace(/{(.*?)}/g,(o,n)=>e.path?.hasOwnProperty(n)?t(String(e.path[n])):o),i=r.BASE+s;return e.query?i+ye(e.query):i},fe=r=>{if(r.formData){let e=new FormData,t=(s,i)=>{F(i)||J(i)?e.append(s,i):e.append(s,JSON.stringify(i))};return Object.entries(r.formData).filter(([,s])=>s!=null).forEach(([s,i])=>{Array.isArray(i)?i.forEach(o=>t(s,o)):t(s,i)}),e}},W=async(r,e)=>typeof e=="function"?e(r):e,he=async(r,e)=>{let[t,s,i,o]=await Promise.all([W(e,r.TOKEN),W(e,r.USERNAME),W(e,r.PASSWORD),W(e,r.HEADERS)]),n=Object.entries({Accept:"application/json",...o,...e.headers}).filter(([,a])=>a!=null).reduce((a,[d,p])=>({...a,[d]:String(p)}),{});if(V(t)&&(n.Authorization=`Bearer ${t}`),V(s)&&V(i)){let a=me(`${s}:${i}`);n.Authorization=`Basic ${a}`}return e.body!==void 0&&(e.mediaType?n["Content-Type"]=e.mediaType:J(e.body)?n["Content-Type"]=e.body.type||"application/octet-stream":F(e.body)?n["Content-Type"]="text/plain":K(e.body)||(n["Content-Type"]="application/json")),new Headers(n)},be=r=>{if(r.body!==void 0)return r.mediaType?.includes("application/json")||r.mediaType?.includes("+json")?JSON.stringify(r.body):F(r.body)||J(r.body)||K(r.body)?r.body:JSON.stringify(r.body)},xe=async(r,e,t,s,i,o,n)=>{let a=new XMLHttpRequest;return a.open(e.method,t,!0),a.withCredentials=r.WITH_CREDENTIALS,o.forEach((d,p)=>{a.setRequestHeader(p,d)}),new Promise(async(d,p)=>{a.onload=()=>d(a),a.onabort=()=>p(new Error("Request aborted")),a.onerror=()=>p(new Error("Network error"));for(let b of r.interceptors.request._fns)a=await b(a);a.send(s??i),n(()=>a.abort())})},we=(r,e)=>{if(e){let t=r.getResponseHeader(e);if(F(t))return t}},_e=r=>{if(r.status!==204)try{let e=r.getResponseHeader("Content-Type");if(e)return e.includes("application/json")||e.includes("+json")?JSON.parse(r.responseText):r.responseText}catch(e){console.error(e)}},ve=(r,e)=>{let s={400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"Im a teapot",421:"Misdirected Request",422:"Unprocessable Content",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required",...r.errors}[e.status];if(s)throw new k(r,e,s);if(!e.ok){let i=e.status??"unknown",o=e.statusText??"unknown",n=(()=>{try{return JSON.stringify(e.body,null,2)}catch{return}})();throw new k(r,e,`Generic Error: status: ${i}; status text: ${o}; body: ${n}`)}},h=(r,e)=>new $(async(t,s,i)=>{try{let o=ge(r,e),n=fe(e),a=be(e),d=await he(r,e);if(!i.isCancelled){let p=await xe(r,e,o,a,n,d,i);for(let T of r.interceptors.response._fns)p=await T(p);let b=_e(p),q=we(p,e.responseHeader),C={url:o,ok:de(p.status),status:p.status,statusText:p.statusText,body:q??b};ve(e,C),t(C.body)}}catch(o){s(o)}});var P=class{static getCorpInfo(e){return h(m,{method:"GET",url:"/search/corp_info",query:{corpname:e.corpname,usesubcorp:e.usesubcorp,subcorpora:e.subcorpora,gramrels:e.gramrels,corpcheck:e.corpcheck,registry:e.registry,struct_attr_stats:e.structAttrStats,format:e.format}})}static getWordList(e){return h(m,{method:"GET",url:"/search/wordlist",query:{corpname:e.corpname,wlattr:e.wlattr,usesubcorp:e.usesubcorp,wlnums:e.wlnums,wlmaxfreq:e.wlmaxfreq,wlminfreq:e.wlminfreq,wlpat:e.wlpat,wlsort:e.wlsort,wlblacklist:e.wlblacklist,include_nonwords:e.includeNonwords,relfreq:e.relfreq,reldocf:e.reldocf,wlfile:e.wlfile,wlicase:e.wlicase,wlmaxitems:e.wlmaxitems,wlpage:e.wlpage,format:e.format,random:e.random,wltype:e.wltype,ngrams_n:e.ngramsN,ngrams_max_n:e.ngramsMaxN,nest_ngrams:e.nestNgrams,simple_n:e.simpleN,usengrams:e.usengrams}})}static getStructWordList(e){return h(m,{method:"GET",url:"/search/struct_wordlist",query:{corpname:e.corpname,wlattr:e.wlattr,wlstruct_attr1:e.wlstructAttr1,wlstruct_attr2:e.wlstructAttr2,wlstruct_attr3:e.wlstructAttr3,wlnums:e.wlnums,wlmaxfreq:e.wlmaxfreq,wlminfreq:e.wlminfreq,wlmaxitems:e.wlmaxitems,wlpat:e.wlpat,wlsort:e.wlsort,wlblacklist:e.wlblacklist,include_nonwords:e.includeNonwords,relfreq:e.relfreq,reldocf:e.reldocf,wlicase:e.wlicase,wlpage:e.wlpage,format:e.format,random:e.random,wltype:e.wltype}})}static getConcordance(e){return h(m,{method:"GET",url:"/search/concordance",query:{corpname:e.corpname,q:e.q,"concordance_query[queryselector]":e.concordanceQueryQueryselector,"concordance_query[iquery]":e.concordanceQueryIquery,"concordance_query[cql]":e.concordanceQueryCql,"concordance_query[lemma]":e.concordanceQueryLemma,"concordance_query[char]":e.concordanceQueryChar,"concordance_query[word]":e.concordanceQueryWord,"concordance_query[phrase]":e.concordanceQueryPhrase,usesubcorp:e.usesubcorp,lpos:e.lpos,default_attr:e.defaultAttr,attrs:e.attrs,refs:e.refs,attr_allpos:e.attrAllpos,viewmode:e.viewmode,cup_hl:e.cupHl,structs:e.structs,fromp:e.fromp,pagesize:e.pagesize,kwicleftctx:e.kwicleftctx,kwicrightctx:e.kwicrightctx,errcorr_switch:e.errcorrSwitch,cup_err_code:e.cupErrCode,cup_err:e.cupErr,cup_corr:e.cupCorr,json:e.json,asyn:e.asyn,format:e.format}})}static getFullRef(e){return h(m,{method:"GET",url:"/search/fullref",query:{corpname:e.corpname,pos:e.pos}})}static getWideCtx(e){return h(m,{method:"GET",url:"/search/widectx",query:{corpname:e.corpname,pos:e.pos,hitlen:e.hitlen,structs:e.structs,detail_left_ctx:e.detailLeftCtx,detail_right_ctx:e.detailRightCtx}})}static getFreqMl(e){return h(m,{method:"GET",url:"/search/freqml",query:{corpname:e.corpname,ml1attr:e.ml1Attr,ml1ctx:e.ml1Ctx,ml2attr:e.ml2Attr,ml2ctx:e.ml2Ctx,ml3attr:e.ml3Attr,ml3ctx:e.ml3Ctx,ml4attr:e.ml4Attr,ml4ctx:e.ml4Ctx,ml5attr:e.ml5Attr,ml5ctx:e.ml5Ctx,ml6attr:e.ml6Attr,ml6ctx:e.ml6Ctx,q:e.q,usesubcorp:e.usesubcorp,fmaxitems:e.fmaxitems,fpage:e.fpage,group:e.group,showpoc:e.showpoc,showreltt:e.showreltt,showrel:e.showrel,freqlevel:e.freqlevel,json:e.json,freq_sort:e.freqSort,format:e.format}})}static getFregDistrib(e){return h(m,{method:"GET",url:"/search/freq_distrib",query:{corpname:e.corpname,res:e.res,lpos:e.lpos,default_attr:e.defaultAttr,attrs:e.attrs,structs:e.structs,refs:e.refs,attr_allpos:e.attrAllpos,viewmode:e.viewmode,fc_lemword_window_type:e.fcLemwordWindowType,fc_lemword_wsize:e.fcLemwordWsize,fc_lemword_type:e.fcLemwordType,fc_pos_window_type:e.fcPosWindowType,fc_pos_wsize:e.fcPosWsize,fc_pos_type:e.fcPosType,json:e.json,normalize:e.normalize,format:e.format}})}static getFreqDist(e){return h(m,{method:"GET",url:"/search/freqdist",query:{corpname:e.corpname,wlattr:e.wlattr,diaattr:e.diaattr,sse:e.sse,threshold:e.threshold,ctx:e.ctx,wordlist:e.wordlist,json:e.json}})}static getCollx(e){return h(m,{method:"GET",url:"/search/collx",query:{corpname:e.corpname,q:e.q,usesubcorp:e.usesubcorp,cattr:e.cattr,csortfn:e.csortfn,cbgrfns:e.cbgrfns,cfromw:e.cfromw,ctow:e.ctow,cminfreq:e.cminfreq,cminbgr:e.cminbgr,cmaxitems:e.cmaxitems,json:e.json}})}static getSubCorp(e){return h(m,{method:"GET",url:"/search/subcorp",query:{corpname:e.corpname,subcname:e.subcname,create:e.create,delete:e._delete,q:e.q,struct:e.struct,json:e.json,format:e.format}})}static subcorpusRename(e){return h(m,{method:"GET",url:"/search/subcorpus_rename",query:{corpname:e.corpname,subcorp_id:e.subcorpId,new_subcorp_name:e.newSubcorpName}})}static subcorpusInfo(e){return h(m,{method:"GET",url:"/search/subcorp_info",query:{corpname:e.corpname,subcname:e.subcname}})}static getExtractKeywords(e){return h(m,{method:"GET",url:"/search/extract_keywords",query:{corpname:e.corpname,ref_corpname:e.refCorpname,usesubcorp:e.usesubcorp,simple_n:e.simpleN,wlfile:e.wlfile,wlblacklist:e.wlblacklist,attr:e.attr,alnum:e.alnum,onealpha:e.onealpha,minfreq:e.minfreq,maxfreq:e.maxfreq,max_keywords:e.maxKeywords,include_nonwords:e.includeNonwords,icase:e.icase,wlpat:e.wlpat,addfreqs:e.addfreqs,reldocf:e.reldocf,usengrams:e.usengrams,ngrams_n:e.ngramsN,ngrams_max_n:e.ngramsMaxN,format:e.format}})}static getTextTypesWithNorms(e){return h(m,{method:"GET",url:"/search/textypes_with_norms",query:{corpname:e.corpname}})}static getAttrVals(e){return h(m,{method:"GET",url:"/search/attr_vals",query:{corpname:e.corpname,avattr:e.avattr,avpat:e.avpat,avfrom:e.avfrom,avmaxitems:e.avmaxitems,icase:e.icase,format:e.format}})}};m.interceptors.response.use(r=>(r.status===200&&console.log(`request to ${r.status} was successful`),r));function ee(r){let e=r.split(" "),t="q";for(let s=0;s<e.length;s++)t+='"'+e[s]+'" ';return t}async function X(r){return await P.getWordList({corpname:r.corpname,wlattr:r.wlattr,wlpat:r.wlpat,wlmaxitems:r.wlmaxitems,wltype:r.wltype,includeNonwords:r.includeNonwords,wlicase:r.wlicase,wlminfreq:r.wlminfreq,wlsort:r.wlsort})}async function Q(r,e){let t=document.querySelector(`#${e.selectQueryId}`),s=e.urlparam?"url":t.value;var i=s==="simple"?ee(r):s==="url"?r:`q${r}`;let o=await P.getConcordance({corpname:e.corpname,q:i,viewmode:e.viewmode,attrs:e.attrs,format:e.format,structs:e.structs,kwicrightctx:e.kwicrightctx,kwicleftctx:e.kwicleftctx,refs:e.refs,pagesize:e.pagesize,fromp:e.fromp});s==="url"&&(t.value="cql");let n=new URLSearchParams(window.location.search);return n.set("corpname",e.corpname),n.set("q",i),n.set("viewmode",e.viewmode),n.set("attrs",e.attrs),n.set("format",e.format),n.set("structs",e.structs),n.set("kwicrightctx",e.kwicrightctx),n.set("kwicleftctx",e.kwicleftctx),n.set("refs",e.refs),n.set("pagesize",e.pagesize.toString()),n.set("fromp",e.fromp.toString()),n.set("selectQueryValue","url"),window.history.pushState({},"",`${window.location.pathname}?${n}`),o.Lines&&o.Lines.length===0?"No results found":(o.error&&(o.error=`${o.error} see documentation at <a target="_blank" class="text-blue-500" href="https://www.sketchengine.eu/documentation/corpus-querying/">https://www.sketchengine.eu/documentation/corpus-querying/</a>`),o)}async function te(r,e){let t=document.querySelector(`#${e.selectQueryId}`),s=e.urlparam?"url":t.value;var i=s==="simple"?ee(r):s==="url"?r:`q${r}`;return await P.getConcordance({corpname:e.corpname,q:i,viewmode:e.viewmode,attrs:e.attrs,format:e.format,structs:e.structs,kwicrightctx:e.kwicrightctx,kwicleftctx:e.kwicleftctx,refs:e.refs,pagesize:e.pagesize,fromp:e.fromp})}function Y(r){let e=[];return r.Lines?.map(t=>{let s=t.Left?.map(p=>p.str).join(" "),i=t.Right?.map(p=>p.str).join(" "),o=t.Kwic?.map(p=>p.str).join(" "),n=t.Kwic?.map(p=>p.attr).join(" "),a=t.Refs?.map(p=>p),d={left:s,right:i,kwic:o,kwic_attr:n,refs:a};e.push(d)}),e}function re(r,e){let t=[];return r.Items?.map(s=>{let i=s.frq,o=s.relfreq,n=s.str,a={frq:i,relfreq:o,str:n,attr:e};t.push(a)}),t}function se(r,e){let t=document.querySelector(`#${e.id}`);t&&t.remove();let s=document.querySelector(`#${r}`),i=document.createElement("div");i.id=e.id,i.classList.add(...e.css.div.split(" ")),i.style.minWidth="250px",i.style.minHeight="50px",s?.prepend(i);let o=document.createElement("div");o.classList.add(...e.css.loader.split(" ")),o.classList.add("loader"),i.appendChild(o);let n=new KeyframeEffect(o,[{transform:"rotate(0deg)"},{transform:"rotate(1080deg)"}],{duration:3e3,direction:"alternate",easing:"linear",iterations:1e3});return new Animation(n,document.timeline).play(),!0}function oe(r,e,t){let s=document.getElementById(t.id),i=document.createElement("ul");i.classList.add(...t.css.ul.split(" ")),r.map(o=>{let n=document.createElement("li");n.classList.add(...t.css.li.split(" ")),n.innerHTML=o.str+" | "+o.frq+" | "+o.attr,n.addEventListener("click",()=>{document.getElementById(e+"-select").value="cql";let a=document.getElementById(e+"-input");a.value="["+o.attr+'="'+o.str+'"]'}),i.appendChild(n)}),s?.appendChild(i),document.querySelector(".loader")?.remove()}function ie(r){return r.fullsize}function Z(r,e=!1){if(e){for(let s of r)if(s.startsWith("doc.id"))return[s.split("=")[1]]}else{var t=[];for(let s of r)s===""||s===void 0||s===null||s.startsWith("doc")||t.push(s);return t}return null}var f={div:"overflow-x-auto",table:"table",head:"text-center",trHead:"",th:"text-sm text-gray-500",tbody:"",trBody:"p-2",td:"text-sm text-gray-500",kwic:"text-lg text-red-500",left:"text-sm text-gray-500 p-2 text-right",right:"text-sm text-gray-500 p-2 text-left",item:"p-4 border rounded-md"};function ne(r,e,t,s,i=!1,o=!0,n=!1,a=!1,d=!1,p){if(d){d(r,t,p,e);return}let b=document.querySelector(`#${t}`);if(o){b.innerHTML=`
		<div class="${p.css?.div||f.div}">
			<table class="${p.css?.table||f.table}">
				<thead class="${p.css?.head||f.head}">
				<tr class="${p.css?.trHead||f.trHead}" id="hits-header-row">
				</tr>
				</thead>
				<tbody class="${p.css?.tbody||f.tbody}" id="hits-table-body">
				</tbody>
			</table>
		</div>
		`;var q=document.querySelector("#hits-table-body"),C=`<th class="${p.css?.th||f.th}">Left KWIC</th>
							<th class="${p.css?.th||f.th}">Context</th>
							<th class="${p.css?.th||f.th}">Right KWIC</th>`,T=""}var I={};let H=r.map((v,A)=>{let j=v.left,L=v.right,S=v.kwic,U=v.kwic_attr?.split("/"),l=v.refs,u=Z(l,!0),y=Z(l,!1),g=s.length>0,x=g&&s.endsWith("/")?s:s+"/",E=g?x:"";if(o){var N=l.filter(w=>w.length>0&&w.includes("title")).map(w=>`<th class="${p.css?.th||f.th}">${w.split("=")[0]}</th>`).join("");T=N;var ce=l.filter(w=>w.length>0&&w.includes("title")).map(w=>`<td class="${p.css?.td||f.td}">${w.split("=")[1]}</td>`).join("")}else var N=l.filter(_=>_.length>0&&_.includes("title")).map(_=>`<span>${_.split("=")[1]}</span><br>`).join("");let D="";if(a){if(e){var G=e.indexOf("id");D=U[G]}var O="line-"+A+"__"+u+"__"+D;I[O]=v}else if(n){if(e){var G=e.indexOf("id");D=U[G]}var R=n(v)}else{let w=y.filter(_=>!_.startsWith("doc")&&_.length>0).map(_=>`#${_.split("=")[1]}`).join("");if(e){var G=e.indexOf("id");D=U[G]}if(D||(console.log("id attribute is not present in the client attributes"),D=""),E&&E.startsWith("http"))var R=new URL(x+u);else if(E&&!E.startsWith("http"))var R=new URL(window.location.origin+x+u);else var R=new URL(window.location.origin+window.location.pathname+u);if(typeof i=="object")for(let _ of Object.entries(i))R.searchParams.set(_[0],_[1]);D?(console.log(D),R.hash=D):(console.log(w),R.hash=w)}return o?`
			<tr class="${p.css?.trBody||f.trBody}">
				${ce}
				<td class="${p.css?.left||f.left}">${j}</td>
				<td class="${p.css?.kwic||f.kwic}" ${O?`id="${O}"`:""}>
         ${a?S:`<a href="${R}">
						${S}
					</a>`}
				</td>
				<td class="${p.css?.right||f.right}">${L}</td>
			</tr>
			`:`
          <div class="${p.css?.item||f.item}" ${O?`id="${O}"`:""}>
          ${a?`<span>${j}</span><span class="${p.css?.kwic||f.kwic}">${S} </span><span>${L}</span>`:`<a href="${R}">
                  <span>${j}</span><span class="${p.css?.kwic||f.kwic}">${S} </span><span>${L}</span>
                </a>`} 
          <small class="${p.css?.head||f.head} align-bottom"><br>${N}</small>
          </div>
          `}).join("");if(o){let v=T+C,A=document.querySelector("#hits-header-row");A.innerHTML=v,q.innerHTML=H}else b.innerHTML=H;a&&a(I)}var Te="Assertion failed";function ae(r,e){if(r===!1||r==null)throw e==null?new Error(Te):typeof e=="function"?e():new Error(e)}function z(r,e){ae(Number.isSafeInteger(e)&&e>0,"Delay must be positive integer.");let t=null,s,i,o;function n(){let a=performance.now()-s;a<e?t=setTimeout(n,e-a):(t=null,r.apply(i,o))}return function(...a){s=performance.now(),i=this,o=a,t==null&&(t=setTimeout(n,e))}}var pe=class{constructor(e){c(this,"viewmode","kwic");c(this,"attrs","word,id");c(this,"format","json");c(this,"structs","doc");c(this,"kwicrightctx","100#");c(this,"kwicleftctx","100#");c(this,"refs","doc.id");c(this,"fromp",1);c(this,"container","noske-search");c(this,"inputPlaceholder","Search for words, phrases or CQL queries (Regex allowed)");c(this,"hitsCss","p-2");c(this,"results","No Hits found. Please try another search query.");c(this,"paginationcss","p-2");c(this,"selectcss","basis-2/12 p-2");c(this,"inputcss","basis-10/12 rounded border p-2");c(this,"div1css","flex flex-row p-2");c(this,"button","search");c(this,"buttoncss","p-2");c(this,"selectQueryCss","basis-2/12 p-2");c(this,"customUrl","");c(this,"urlparam",!1);c(this,"statsDiv","flex flex-row m-2");c(this,"statsLabel","p-2");c(this,"statsLabelValue","Hits:");c(this,"wordlistattr",["word","lemma","type","id"]);c(this,"autocompleteOptions",{id:"noske-autocomplete",regexType:"contains",css:{div:"bg-white border border-gray-300 absolute ml-40 mt-10 text-left",ul:"p-0",li:"p-2 hover:bg-gray-100 text-sm text-gray-500 hover:cursor-pointer",loader:"m-2 border-4 border-gray-300 border-t-4 border-t-black rounded-full relative w-[40px] h-[40px] text-center"}});c(this,"minQueryLength",2);c(this,"autocomplete",!1);c(this,"getWordsList",X);c(this,"pagesize",20);e?.container||console.log("No container defined. Default container id set to 'noske-search'."),this.autocomplete=e?.autocomplete||this.autocomplete,this.container=e?.container||this.container,this.wordlistattr=e?.wordlistattr||this.wordlistattr}search({debug:e=!1,client:t,hits:s,pagination:i,searchInput:o,config:n,stats:a,autocompleteOptions:d}){if(console.log("search initialized"),this.searchInput(o),this.clearResults(s.id,i.id,o.id,a.id),!s.id)throw new Error("hits.id is not defined");if(this.searchHits(s),!i.id)throw new Error("pagination.id is not defined");if(this.searchPagination(i),t.base===void 0||t.base==="")throw new Error("Base URL is not defined");if(m.BASE=t.base,t.corpname===void 0||t.corpname==="")throw new Error("Corpus name is not defined");let p=document.querySelector(`#${o?.id}-select`),b=document.querySelector(`input#${o?.id}-input`),q=document.querySelector("button#noske-search-button"),C=async l=>{let u=[];for(let y of this.wordlistattr){if(y.length===0)return;let g=await X({corpname:t.corpname,wlattr:y,wlmaxitems:100,wlpat:l,wltype:"simple",includeNonwords:1,wlicase:1,wlminfreq:0});if(e&&g!==null&&console.log(g),g!==null){let x=re(g,y);u.push(...x)}}return u},T=()=>{document.getElementById(d.id||"noske-autocomplete")?.remove()},I=()=>{b.addEventListener("focus",l=>{l.preventDefault(),T()})},H=l=>({startsWith:l=`^${l}.*`,endsWith:l=`.*${l}$`,contains:l=`.*${l}.*`})[d?.regexType||this.autocompleteOptions.regexType],v=()=>{this.autocomplete!==!1&&b.addEventListener("input",z(async l=>{if(document.getElementById(o.id)?.classList.add("relative"),se(o.id,d||this.autocompleteOptions)){let y=l.target.value,g=H(y);if(y.length>=this.minQueryLength&&y.startsWith("[")===!1){let x=await C(g);x!==void 0&&(oe(x,o.id,d||this.autocompleteOptions),I())}else T()}},250))},A=async l=>{if(l.length>=this.minQueryLength){let u=await Q(l,{corpname:t.corpname,viewmode:t.viewmode||this.viewmode,attrs:t.attrs||this.attrs,format:t.format||this.format,structs:t.structs||this.structs,kwicrightctx:t.kwicrightctx||this.kwicrightctx,kwicleftctx:t.kwicleftctx||this.kwicleftctx,refs:t.refs||this.refs,pagesize:t.pagesize||this.pagesize,fromp:t.fromp||this.fromp,selectQueryId:`${o?.id}-select`});if(e&&u!==null&&console.log(u),await this.transformResponse(u,t,s,i,n,a),await this.createPagination(1,t,s,i,o.id,n,a),a.customQueryStats){let y=`${s.id}-init`,g=u&&u!=="No results found"?u.fullsize:999999,x=await S(l,g);a.customQueryStats(l,Y(x),g,y)}}},j=()=>{b.addEventListener("keydown",z(l=>{if(l.key==="Enter"){let u=l.target.value;A(u),T()}},250))},L=async()=>{let l=new URL(window.location.href),u=l.searchParams.get("q");if(u){e?p.value="simple":p.value="cql";let y=document.querySelector(`input#${o?.id}-input`);y.value=u?.startsWith("q")?u.slice(1):u;let g=await Q(u,{corpname:l.searchParams.get("corpname"),viewmode:l.searchParams.get("viewmode"),attrs:l.searchParams.get("attrs"),format:l.searchParams.get("format"),structs:l.searchParams.get("structs"),kwicrightctx:l.searchParams.get("kwicrightctx"),kwicleftctx:l.searchParams.get("kwicleftctx"),refs:l.searchParams.get("refs"),pagesize:parseInt(l.searchParams.get("pagesize")),fromp:parseInt(l.searchParams.get("fromp")),selectQueryId:`${o?.id}-select`,urlparam:!0});if(e&&g!==null&&console.log(g),await this.transformResponse(g,t,s,i,n,a),await this.createPagination(1,t,s,i,o.id,n,a),a.customQueryStats){let x=`${s.id}-init`,E=g&&g!=="No results found"?g.fullsize:999999,N=await S(y.value,E);a.customQueryStats(y.value,Y(N),E,x)}}},S=async(l,u=999999)=>{if(l.length>=this.minQueryLength){let y=await te(l,{corpname:t.corpname,viewmode:t.viewmode||this.viewmode,attrs:t.attrs||this.attrs,format:t.format||this.format,structs:t.structs||this.structs,kwicrightctx:t.kwicrightctx||this.kwicrightctx,kwicleftctx:t.kwicleftctx||this.kwicleftctx,refs:t.refs||this.refs,pagesize:u,fromp:t.fromp||this.fromp,selectQueryId:`${o?.id}-select`});return e&&y!==null&&console.log(y),y}throw new Error(`Query length is less than minimum length of: ${this.minQueryLength}`)},U=()=>{q.addEventListener("click",z(()=>{let u=document.querySelector(`input#${o?.id}-input`).value;A(u),T()},250))};L(),v(),j(),U()}searchHits({id:e,css:t}){if(!e)throw new Error("search hits id is not defined");let s=document.querySelector(`#${e}`);s.innerHTML=`<div id="${e}-init" class="${t?.div||this.hitsCss}"></div>`}searchPagination({id:e,css:t}){if(!e)throw new Error("search pagination id is not defined");let s=document.querySelector(`#${e}`);s.innerHTML=`<div id="${e}-init"
                              class="${t?.div||this.paginationcss}"></div>`}searchInput({id:e,placeholder:t,button:s,css:i}){if(!this.container)throw new Error("main search div container is not defined");if(!e)throw new Error("search input id is not defined");let o=document.querySelector(`#${this.container}`);o.innerHTML=`<div id="${e}" class="${i?.div||this.div1css}">
        <select id="${`${e}-select`}"
          class="${i?.select||this.selectQueryCss}">
          <option value="simple">simple</option>
          <option value="cql">cql</option>
        </select>
        <input
          type="search"
          id="${`${e}-input`}"
          class="${i?.input||this.inputcss}"
          placeholder="${t||this.inputPlaceholder}"
          autocomplete="off"
        />
        <button id="noske-search-button" class="${i?.button||this.buttoncss}">${s||this.button}</button>
      </div>
    `}transformStats(e,t,s){let i=document.querySelector(`#${e.id}`),o=`<div id="${e.id}-init" class="${e.css?.div}">
                    <label class="${e.css?.label}">${s} ${t}</label>
                  </div>`;i.innerHTML=o}async transformResponse(e,t,s,i,o,n){let a=document.querySelector(`#${s.id}-init`);if(a.innerHTML="",e==="No results found")a.innerHTML=o?.results||this.results;else if(e.error)a.innerHTML=e.error;else{let d=Y(e),p=ie(e),b=t.attrs?.split(","),q=Math.ceil(p/(t?.pagesize||this.pagesize)),C=document.querySelector(`#${i.id}-init`);C.innerHTML=`<select id="${`${i.id}-select`}"
          class="${i.css?.select||this.selectcss}">
          ${Array.from({length:q},(T,I)=>`<option value="${I+1}">${I+1}</option>`).join("")}
        </select>`,ne(d,b,`${s.id}-init`,o?.customUrl||this.customUrl,o?.urlparam||this.urlparam,o?.tableView,o?.customUrlTransform,o?.customSynopticView,o?.customResponseHtml,s),p&&this.transformStats({id:n.id,css:{div:n.css?.div||this.statsDiv,label:n.css?.label||this.statsLabel}},p,n.label||this.statsLabelValue)}}async createPagination(e=1,t,s,i,o,n,a){let d=document.querySelector(`#${i.id}-select`);d.addEventListener("change",async p=>{t.fromp=parseInt(p.target.value);let b=document.querySelector(`input#${o}-input`).value,q=await Q(b,{corpname:t.corpname,viewmode:t.viewmode||this.viewmode,attrs:t.attrs||this.attrs,format:t.format||this.format,structs:t.structs||this.structs,kwicrightctx:t.kwicrightctx||this.kwicrightctx,kwicleftctx:t.kwicleftctx||this.kwicleftctx,refs:t.refs||this.refs,pagesize:t.pagesize||this.pagesize,fromp:t.fromp||this.fromp,selectQueryId:`${o}-select`});await this.transformResponse(q,t,s,i,n,a),await this.createPagination(p.target.value,t,s,i,o,n,a)}),d.value=e.toString()}clearResults(e,t,s,i){document.querySelector(`input#${s}-input`).addEventListener("input",async n=>{if(n.target.value.length===0){let d=document.querySelector(`#${e}-init`);d.innerHTML="";let p=document.querySelector(`#${t}-init`);p.innerHTML="",document.querySelector(`#${i}-init`)?.remove(),window.history.pushState({},"",`${window.location.pathname}`),document.getElementById("nokse-autocomplete")?.remove()}})}};export{pe as NoskeSearch};
//# sourceMappingURL=index.js.map